<!DOCTYPE html>
<html lang="en">
  <head>   
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" type="text/css" href="lexxari.css" />
      <title>Lexxari</title>
  </head>
  <body>
      <div class="top-bar">
          <img src="lexxari_primary_black_white.png" alt="Lexxari Logo" class="logo">
      </div>

      <div class="page-container">
          <!-- Left Panel (20%) -->
          <div class="left-panel">
              <div style="width: 100%; max-width: 500px; vertical-align:top;">
                  <div class="container" id="policy-details" style="font-size: 16px;"></div>
                  <div class="container">
                      <label>Status</label><br>
                      <div class="progress-bar" id="progressBar">0%</div>
                  </div>
                  <div class="container">
                    <form id="uploadForm">
                        <div class="form-group" id="damage-type">
                            <label>Damage Type *</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="damageType" value="hail" id="hail">
                                    <span>Hail</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="damageType" value="wind" id="wind">
                                    <span>Wind</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="damageType" value="fire" id="fire">
                                    <span>Fire</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Select File *</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="fileInput" name="file" required>
                                <label for="fileInput" class="file-input-label">
                                    <div>
                                        <div class="upload-icon">üìÅ</div>
                                        <div>Click to select a file</div>
                                    </div>
                                </label>
                            </div>
                            <div id="fileInfo" class="file-info" style="display: none;"></div>
                        </div>

                        <button type="submit" id="submitBtn">Upload Policy</button>
                    </form>

                    <div id="successMessage" class="success-message">
                        ‚úÖ Policy uploaded!
                    </div>
                </div>
              </div>
          </div>

          <!-- Right Panel (50%) -->
          <div class="right-panel">
              <div class="top-bar">
                  <img src="lexxari_primary_white_black.png" alt="Smartsheet Logo" class="logo">
                  <h3>Smart Sheet</h3>
              </div>
              <div class="tabs-container">
                  <button class="tab active" data-tab="hail" id="hail-tab" >Hail</button>
                  <button class="tab" data-tab="wind" id="wind-tab" >Wind</button>
                  <button class="tab" data-tab="fire" id="fire-tab">Fire</button>
                  <button class="tab" data-tab="auto" id="auto-tab">Auto</button>
              </div>
              <div id="hail-content" class="tab-content">
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Hail</th>
                              <th>Covered</th>
                          </tr>
                      </thead>
                      <tbody id="hail-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Hail</th>
                              <th>Not Covered</th>
                          </tr>
                      </thead>
                      <tbody id="hail-not-covered-table"">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Hail</th>
                              <th>Deductibles</th>
                          </tr>
                      </thead>
                      <tbody id="hail-deductible-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Hail</th>
                              <th>Amendments</th>
                          </tr>
                      </thead>
                      <tbody id="hail-amendment-table">
                      </tbody>
                  </table>
              </div>

              <div id="wind-content" class="tab-content">
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Wind</th>
                              <th>Covered</th>
                          </tr>
                      </thead>
                      <tbody id="wind-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Wind</th>
                              <th>Not Covered</th>
                          </tr>
                      </thead>
                      <tbody id="wind-not-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Wind</th>
                              <th>Deductibles</th>
                          </tr>
                      </thead>
                      <tbody id="wind-deductible-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Wind</th>
                              <th>Amendments</th>
                          </tr>
                      </thead>
                      <tbody id="wind-amendment-table">
                      </tbody>
                  </table>
              </div>
              
              <div id="fire-content" class="tab-content">
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Fire</th>
                              <th>Covered</th>
                          </tr>
                      </thead>
                      <tbody id="fire-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Fire</th>
                              <th>Not Covered</th>
                          </tr>
                      </thead>
                      <tbody id="fire-not-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Fire</th>
                              <th>Deductibles</th>
                          </tr>
                      </thead>
                      <tbody id="fire-deductible-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Fire</th>
                              <th>Amendments</th>
                          </tr>
                      </thead>
                      <tbody id="fire-amendment-table">
                      </tbody>
                  </table>
              </div>
              
              <div id="auto-content" class="tab-content">
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Auto</th>
                              <th>Coverage & Eligibility</th>
                          </tr>
                      </thead>
                      <tbody id="auto-coverage-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Auto</th>
                              <th>Liability Coverage</th>
                          </tr>
                      </thead>
                      <tbody id="auto-liability-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Auto</th>
                              <th>Physical Damage Coverage</th>
                          </tr>
                      </thead>
                      <tbody id="auto-physical-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Auto</th>
                              <th>UM/UIM Coverage</th>
                          </tr>
                      </thead>
                      <tbody id="auto-um-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Auto</th>
                              <th>PIP/MedPay Coverage</th>
                          </tr>
                      </thead>
                      <tbody id="auto-pip-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Auto</th>
                              <th>Exclusions & Limitations</th>
                          </tr>
                      </thead>
                      <tbody id="auto-exclusions-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <thead>
                          <tr>
                              <th>Auto</th>
                              <th>General Conditions</th>
                          </tr>
                      </thead>
                      <tbody id="auto-general-table">
                      </tbody>
                  </table>
              </div>

          </div>
          
          <!-- Chat Panel (30%) -->
          <div class="chat-panel">
            <div class="chat-header">
                <h1>
                    <img src="lexxari_black_transparent.png" alt="Lexxari Logo" class="logo-icon">
                    Lexxari
                </h1>
            </div>
            <div id="demo_chat" class="demo-chat" >
              <div class="chat-messages" id="messages">
                  <div class="message bot">
                      <div class="message-avatar">L</div>
                      <div class="message-content">Hello! How can I help you today?</div>
                  </div>
              </div>

              <div class="chat-input-container">
                  <div class="chat-input-wrapper">
                      <input 
                          type="text" 
                          class="chat-input" 
                          id="messageInput" 
                          placeholder="Type a message..."
                          autocomplete="off"
                      >
                      <button class="send-button" id="sendButton">Send</button>
                  </div>
              </div>
            </div>
          </div>
      </div>
  </body>
  <script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const successMessage = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const fileSize = (file.size / 1024).toFixed(2);
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>Selected:</strong> ${file.name}<br>
                <strong>Size:</strong> ${fileSize} KB<br>
                <strong>Type:</strong> ${file.type || 'Unknown'}
            `;
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const hail = document.getElementById('hail').checked;
        const wind = document.getElementById('wind').checked;
        const fire = document.getElementById('fire').checked;
        const auto = isAuto();
        const file = fileInput.files[0];
        
        var url = window.location.href;
        var lastPart = url.substr(url.lastIndexOf('/') + 1);

        if (!file) {
            alert('Please select a file');
            return;
        }
        
        var url = window.location.href;
        var lastPart = url.substr(url.lastIndexOf('/') + 1);

        var progress_step = 80;
        var step_divide = 0;
        if (!auto) {

          if (!hail && !fire && !wind) {
              alert('Please select at least one damage type');
              return;
          }
          
          if (hail)
              step_divide = step_divide + 1;
          if (wind)
              step_divide = step_divide + 1;
          if (fire)
              step_divide = step_divide + 1;
              
          progress_step = progress_step / step_divide;
        }
        
        // Simulate upload process
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';

        // Here you would normally send the data to a server
        // For demonstration, we'll just simulate a delay
        setTimeout(() => {
            successMessage.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Upload Policy';
            
          setProgress(20);

          const form = new FormData();
            form.append('pdf_file', file);

          (async () => {
            const rawResponse = await fetch('/api/upload', {
              method: 'POST',
              headers: {
                'accept': 'application/json'
              },
              body: form
            });
            
            const upload_response = await rawResponse.json();
            if (upload_response) {
              //  Show chat
              document.getElementById('demo_chat').style.display = 'block';
              
              fetch("policy_details.json")
                .then(response => response.json())
                .then(json => loadPolicyDetails(json));
              
            
              if (hail) {              
                fetch("hail_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("covered",json, progress_step/4));
                fetch("hail_not_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("not-covered",json, progress_step/4));
                fetch("hail_deductible.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("deductible",json, progress_step/4));
                fetch("hail_amendment.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("amendment",json, progress_step/4));
              }

              if (wind) {              
                fetch("wind_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("covered",json, progress_step/4));
                fetch("wind_not_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("not-covered",json, progress_step/4));
                fetch("wind_deductible.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("deductible",json, progress_step/4));
                fetch("wind_amendment.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("amendment",json, progress_step/4));
              }

              if (fire) {              
                fetch("fire_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("covered",json, progress_step/4));
                fetch("fire_not_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("not-covered",json, progress_step/4));
                fetch("fire_deductible.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("deductible",json, progress_step/4));
                fetch("fire_amendment.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("amendment",json, progress_step/4));
              }

              if (auto) {              
                fetch("auto_coverage.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("coverage",json, progress_step/7));
                fetch("auto_liability.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("liability",json, progress_step/7));
                fetch("auto_physical.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("physical",json, progress_step/7));
                fetch("auto_UM.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("um",json, progress_step/7));
                fetch("auto_PIP.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("pip",json, progress_step/7));
                fetch("auto_exclusions.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("exclusions",json, progress_step/7));
                fetch("auto_general.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("general",json, progress_step/7));
              }
            }
          })();
        }, 1500);
    });

    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const windCheckbox = document.getElementById('wind');
    const hailCheckbox = document.getElementById('hail');
    const fireCheckbox = document.getElementById('fire');
    const windTab = document.querySelector('[data-tab="wind"]');
    const hailTab = document.querySelector('[data-tab="hail"]');
    const fireTab = document.querySelector('[data-tab="fire"]');
    const autoTab = document.querySelector('[data-tab="auto"]');
    const damageType =  document.getElementById('damage-type');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab
            tab.classList.add('active');

            // Show corresponding content
            const tabName = tab.getAttribute('data-tab');
            document.getElementById(`${tabName}-content`).classList.add('active');
        });
    });

    // Show/hide tabs based on checkbox selection
    function updateTabVisibility() {
        if (hailCheckbox.checked) {
            hailTab.style.display = 'block';
        } else {
            hailTab.style.display = 'none';
            // If this tab was active, switch to another visible tab
            if (hailTab.classList.contains('active') && fireCheckbox.checked) {
                fireTab.click();
            }
            if (hailTab.classList.contains('active') && windCheckbox.checked) {
                windTab.click();
            }
        }

        if (windCheckbox.checked) {
            windTab.style.display = 'block';
        } else {
            windTab.style.display = 'none';
            // If this tab was active, switch to another visible tab
            if (windTab.classList.contains('active') && fireCheckbox.checked) {
                fireTab.click();
            }
            if (windTab.classList.contains('active') && hailCheckbox.checked) {
                hailTab.click();
            }
        }

        if (fireCheckbox.checked) {
            fireTab.style.display = 'block';
        } else {
            fireTab.style.display = 'none';
            // If this tab was active, switch to another visible tab
            if (fireTab.classList.contains('active') && windCheckbox.checked) {
               windTab.click();
            }
            if (fireTab.classList.contains('active') && hailCheckbox.checked) {
               hailTab.click();
            }
        }

        // If no checkboxes are selected, hide all tab content
        if (!hailCheckbox.checked && !windCheckbox.checked && !fireCheckbox.checked) {
            tabContents.forEach(content => content.classList.remove('active'));
        } else {
            // If at least one is checked and no tab is active, activate the first visible one
            const hasActiveTab = Array.from(tabs).some(tab => 
                tab.classList.contains('active') && tab.style.display !== 'none'
            );
            if (!hasActiveTab) {
                if (hailCheckbox.checked) {
                    hailTab.click();
                } else if (windCheckbox.checked) {
                    windTab.click();
                } else if (fireCheckbox.checked) {
                    fireTab.click();
                }
            }
        }
    }

    // Initialize tab visibility (hide all tabs initially)
    hailTab.style.display = 'none';
    windTab.style.display = 'none';
    fireTab.style.display = 'none';
    autoTab.style.display = 'none';

    // Listen for checkbox changes
    hailCheckbox.addEventListener('change', updateTabVisibility);
    windCheckbox.addEventListener('change', updateTabVisibility);
    fireCheckbox.addEventListener('change', updateTabVisibility);

    function loadPolicyDetails(json) {
      const form = new FormData();
      form.append('questions', JSON.stringify(json));
      (async () => {
        var rawResponse = await fetch('/api/pdf-qa', {
          method: 'POST',
          headers: {
            'accept': 'application/json'
          },
          body: form
        });
        
        var answers = await rawResponse.json();

        var policyDetails = document.getElementById("policy-details");
        policyDetails.innerHTML = `
                <table><tr><td><strong>Policy Holder:</strong><br>${answers[0].answer}</td></tr>
                <tr><td><strong>Policy Address:</strong><br>${answers[1].answer}</td></tr>
                <tr><td><strong>Policy Number:</strong><br>${answers[2].answer}</td></tr>
                <tr><td><strong>Policy Period:</strong><br>${answers[3].answer}</td></tr></table>
        `;
      
      })();
    }

    function loadSmartSheet(section, json, progress_step) {
      const form = new FormData();
        form.append('questions', JSON.stringify(json));

      (async () => {
        const rawResponse = await fetch('/api/pdf-qa', {
          method: 'POST',
          headers: {
            'accept': 'application/json'
          },
          body: form
        });
        
        const answers = await rawResponse.json();
        var arrayLength = answers.length;
        
        tableId=json.damage_type.toLowerCase() + "-" + section + "-table";
            
        var currentTable = document.getElementById(tableId);
        var new_tbody = document.createElement('tbody');
        new_tbody.id = tableId;
        
        for (var i = 0; i < arrayLength; i++) {
            var row = document.createElement("tr");
            
            var columnQ = document.createElement("td");
            columnQ.classList.add("question-cell");
            columnQ.textContent = answers[i].question;
            row.appendChild(columnQ);
            
            var columnA = document.createElement("td");
            columnA.classList.add("answer-cell");
            columnA.textContent = answers[i].answer;
            row.appendChild(columnA);
           
            new_tbody.appendChild(row);
         }
         
         currentTable.parentNode.replaceChild(new_tbody, currentTable)
         
         setProgress(getProgress()+progress_step);

         tabId=json.damage_type.toLowerCase() + "-tab";
         document.getElementById(tabId).click();
         
      })();
    }

    function setProgress(percentage) {
        // Ensure percentage is between 0 and 100
        percentage = Math.max(0, Math.min(100, percentage));
        
        
        progressBar.style.width = percentage + '%';
        progressBar.textContent = Math.round( percentage ) + '%';
    }

    function getProgress() {
        return parseFloat(progressBar.style.width);
    }

    const progressBar = document.getElementById('progressBar');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = isUser ? 'U' : 'L';
        
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = text;
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);
        messagesContainer.appendChild(messageDiv);
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        sendButton.disabled = false;             
    }

    function sendMessage() {
        var text = messageInput.value.trim();
        if (!text) return;
        
        addMessage(text, true);
        
        sendButton.disabled = true;             
        var chatQuestions = { questions: [] };
        chatQuestions.questions.push(text);

        var chatForm = new FormData();
        chatForm.append('questions', JSON.stringify(chatQuestions));

        messageInput.value = '';
        
        fetch('/api/pdf-qa', {
          method: 'POST',
          headers: { 'accept': 'application/json' },
          body: chatForm
        })
        .then(response => response.json())
        .then(chatAnswers => addMessage(chatAnswers[0].answer, false));
        
    }

    sendButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    messageInput.focus();

    function isAuto() {
        var url = window.location.href;
        var lastPart = url.substr(url.lastIndexOf('/') + 1);
        if (lastPart == "") {
           lastPart = url.substr(url.lastIndexOf('/', url.lastIndexOf('/')-1)+1, 4);
        } 
        if (lastPart === "auto")
          return true;
          
        return false;
    }

    window.onload = function() { 

        if (isAuto()) {
          autoTab.style.display = 'block';
          damageType.style.display = 'none';
        }  else {
          autoTab.style.display = 'none';
          damageType.style.display = 'block';            
        }
      
    }
      
  </script>
</html>
