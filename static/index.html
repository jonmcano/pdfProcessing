<!DOCTYPE html>
<html lang="en">
  <head>   
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" type="text/css" href="lexxari.css" />
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
      <title>Lexxari</title>
  </head>
  <body>
      <div class="top-bar">
         <div style="display: flex; width: 50%;">
          <img src="lexxari_primary_black_white.png" alt="Lexxari Logo" class="logo">
         </div>
         <div style="justify-content: flex-end; display: flex; width: 50%; align-items: center;">
          <img src="https://i0.wp.com/claimsconnectiongroup.com/wp-content/uploads/2025/10/400-CCG-Logo-Black-on-Trans.png?fit=400%2C250&ssl=1" title="Get started now with CCG" onclick=" window.open('https://claimsconnectiongroup.com/','_blank')" class="logo">
          <strong onclick=" window.open('https://claimsconnectiongroup.com/','_blank')" style="font-size: 12px;">Get started now with CCG</strong>
         </div>
      </div>

      <div class="page-container">
          <!-- Left Panel (20%) -->
          <div class="left-panel">
              <div style="width: 100%; max-width: 500px; vertical-align:top;">
                  <div class="container" id="policy-details" style="font-size: 16px;"></div>
                  <div class="container">
                      <label>Status</label><br>
                      <div class="progress-bar" id="progressBar">0%</div>
                  </div>
                  <div class="container">
                    <form id="uploadForm">
                        <div class="form-group" id="damage-type">
                            <label>Damage Type *</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="damageType" value="hail" id="hail">
                                    <span>Hail</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="damageType" value="wind" id="wind">
                                    <span>Wind</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="damageType" value="fire" id="fire">
                                    <span>Fire</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Select File *</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="fileInput" name="file" required>
                                <label for="fileInput" class="file-input-label">
                                    <div>
                                        <div class="upload-icon">üìÅ</div>
                                        <div>Click or drag file here</div>
                                    </div>
                                </label>
                            </div>
                            <div id="fileInfo" class="file-info" style="display: none;"></div>
                        </div>

                        <button type="submit" id="submitBtn">Upload Policy</button>
                    </form>

                    <div id="successMessage" class="success-message">
                        ‚úÖ Policy uploaded!
                    </div>
                </div>
              </div>
          </div>

          <!-- Right Panel (50%) -->
          <div class="right-panel">
              <div class="top-bar">
                  <div style="width: 100%;">
                    <img src="lexxari_primary_white_black.png" alt="Smartsheet Logo" class="logo">
                    <div style="float:left;line-height:30px;">Smart Sheets</div>
                    <button class="export-button" id="exportButton" >Export Smart Sheet</button>
                    <button class="next-steps-button" id="nextStepsButton" >What next? Start here</button>
                  </div>
              </div>
              <div class="tabs-container">
                  <button class="tab active" data-tab="hail" id="hail-tab" >Hail</button>
                  <button class="tab" data-tab="wind" id="wind-tab" >Wind</button>
                  <button class="tab" data-tab="fire" id="fire-tab">Fire</button>
                  <button class="tab" data-tab="auto" id="auto-tab">Auto</button>
              </div>
              <div id="hail-content" class="tab-content">
                  <table class="qa-table">
                      <tbody class="section-header" data-target="hail-covered-table">
                       <tr><th>HAIL</th><th>COVERED</th></tr>
                      </tbody>
                      <tbody class="content-body" id="hail-covered-table">
                      </tbody>
                      
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="hail-not-covered-table">
                        <tr><th>HAIL</th><th>NOT COVERED</tdh></tr>
                      </tbody>
                      <tbody class="content-body" id="hail-not-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="hail-deductible-table">
                       <tr><th>HAIL</th><th>DEDUCTIBLES</th></tr>
                      </tbody>
                      <tbody class="content-body" id="hail-deductible-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="hail-amendment-table">
                        <tr><th>HAIL</th><th>AMENDMENTS</th></tr>
                      </tbody>
                      <tbody class="content-body" id="hail-amendment-table">
                      </tbody>
                  </table>
              </div>

              <div id="wind-content" class="tab-content">
                  <table class="qa-table">
                      <tbody class="section-header" data-target="wind-covered-table">
                        <tr><th>WIND</th><th>COVERED</th></tr>
                      </tbody>
                      <tbody class="content-body" id="wind-covered-table">
                      </tbody>
                      
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="wind-not-covered-table">
                        <tr><th>WIND</th><th>NOT COVERED</tdh></tr>
                      </tbody>
                      <tbody class="content-body" id="wind-not-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="wind-deductible-table">
                        <tr><th>WIND</th><th>DEDUCTIBLES</th></tr>
                      </tbody>
                      <tbody class="content-body" id="wind-deductible-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="wind-amendment-table">
                        <tr><th>WIND</th><th>AMENDMENTS</th></tr>
                      </tbody>
                      <tbody class="content-body" id="wind-amendment-table">
                      </tbody>
                  </table>
              </div>
              
              <div id="fire-content" class="tab-content">
                  <table class="qa-table">
                      <tbody class="section-header" data-target="fire-covered-table">
                        <tr><th>FIRE</th><th>COVERED</tdh></tr>
                      </tbody>
                      <tbody class="content-body" id="fire-covered-table">
                      </tbody>
                      
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="fire-not-covered-table">
                        <tr><th>FIRE</th><th>NOT COVERED</tdh></tr>
                      </tbody>
                      <tbody class="content-body" id="fire-not-covered-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="fire-deductible-table">
                        <tr><th>FIRE</th><th>DEDUCTIBLES</th></tr>
                      </tbody>
                      <tbody class="content-body" id="fire-deductible-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="fire-amendment-table">
                        <tr><th>FIRE</th><th>AMENDMENTS</th></tr>
                      </tbody>
                      <tbody class="content-body" id="fire-amendment-table">
                      </tbody>
                  </table>
              </div>
              
              <div id="auto-content" class="tab-content">
                  <table class="qa-table">
                      <tbody class="section-header" data-target="auto-coverage-table">
                        <tr><th>AUTO</th><th>COVERAGE & ELIGIBILITY</th></tr>
                      </tbody>
                      <tbody class="content-body" id="auto-coverage-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="auto-liability-table">
                        <tr><th>AUTO</th><th>LIABILITY COVERAGE</th></tr>
                      </tbody>
                      <tbody class="content-body" id="auto-liability-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="auto-physical-table">
                        <tr><th>AUTO</th><th>PHYSICAL DAMAGE COVERAGE</th></tr>
                      </tbody>
                      <tbody class="content-body" id="auto-physical-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="auto-um-table">
                        <tr><th>AUTO</th><th>UM/UIM COVERAGE</th></tr>
                      </tbody>
                      <tbody class="content-body" id="auto-um-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="auto-pip-table">
                        <tr><th>AUTO</th><th>PIP/MEDPAY COVERAGE</th></tr>
                      </tbody>
                      <tbody class="content-body" id="auto-pip-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="auto-exclusions-table">
                        <tr><th>AUTO</th><th>EXCLUSIONS & LIMITATIONS</th></tr>
                      </tbody>
                      <tbody class="content-body" id="auto-exclusions-table">
                      </tbody>
                  </table>
                  <table class="qa-table">
                      <tbody class="section-header" data-target="auto-general-table">
                        <tr><th>AUTO</th><th>GENERAL CONDITIONS</th></tr>
                      </tbody>
                      <tbody class="content-body" id="auto-general-table">
                      </tbody>
                  </table>
              </div>

          </div>
          
          <!-- Chat Panel (30%) -->
          <div class="chat-panel">
            <div class="chat-header">
                <h1>
                    <img src="lexxari_black_transparent.png" alt="Lexxari Logo" class="logo-icon">
                    Ask Lexxari
                </h1>
            </div>
            <div id="demo_chat" class="demo-chat" >
              <div class="chat-messages" id="messages">
                  <div class="message bot">
                      <div class="message-avatar">L</div>
                      <div class="message-content">Hello! How can I help you today?</div>
                  </div>
              </div>

              <div class="chat-input-container">
                  <div class="chat-input-wrapper">
                      <input 
                          type="text" 
                          class="chat-input" 
                          id="messageInput" 
                          placeholder="Type a message..."
                          autocomplete="off"
                      >
                      <button class="send-button" id="sendButton">Send</button>
                  </div>
              </div>
            </div>
          </div>
      </div>

    <!-- Popup overlay -->
    <div class="popup-overlay" id="popupOverlay" onclick="closePopup()">
        <!-- Popup container -->
        <div class="popup" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closePopup()">&times;</button>
            <div class="popup-content" id="popupContent">
            </div>
        </div>
    </div>
    
  </body>
  <script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const successMessage = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');
    const dropZone = document.querySelector('.file-input-label');

    // Drag and drop functionality
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            const file = files[0];
            const fileSize = (file.size / 1024).toFixed(2);
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>Selected:</strong> ${file.name}<br>
                <strong>Size:</strong> ${fileSize} KB<br>
                <strong>Type:</strong> ${file.type || 'Unknown'}
            `;
        }
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const fileSize = (file.size / 1024).toFixed(2);
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>Selected:</strong> ${file.name}<br>
                <strong>Size:</strong> ${fileSize} KB<br>
                <strong>Type:</strong> ${file.type || 'Unknown'}
            `;
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const hail = document.getElementById('hail').checked;
        const wind = document.getElementById('wind').checked;
        const fire = document.getElementById('fire').checked;
        const auto = isAuto();
        const file = fileInput.files[0];
        
        var url = window.location.href;
        var lastPart = url.substr(url.lastIndexOf('/') + 1);

        if (!file) {
            alert('Please select a file');
            return;
        }
        
        var url = window.location.href;
        var lastPart = url.substr(url.lastIndexOf('/') + 1);

        var progress_step = 80;
        var step_divide = 0;
        if (!auto) {

          if (!hail && !fire && !wind) {
              alert('Please select at least one damage type');
              return;
          }
          
          if (hail)
              step_divide = step_divide + 1;
          if (wind)
              step_divide = step_divide + 1;
          if (fire)
              step_divide = step_divide + 1;
              
          progress_step = progress_step / step_divide;
        }
        
        // Simulate upload process
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';

        // Here you would normally send the data to a server
        // For demonstration, we'll just simulate a delay
        setTimeout(() => {
            successMessage.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Upload Policy';
            
          setProgress(20);

          const form = new FormData();
            form.append('pdf_file', file);

          (async () => {
            const rawResponse = await fetch('/api/upload', {
              method: 'POST',
              headers: {
                'accept': 'application/json'
              },
              body: form
            });
            
            const upload_response = await rawResponse.json();
            if (upload_response) {
              //  Show chat
              document.getElementById('demo_chat').style.display = 'block';
              
              fetch("policy_details.json")
                .then(response => response.json())
                .then(json => loadPolicyDetails(json));
              
            
              if (hail) {              
                fetch("hail_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("covered",json, progress_step/4));
                fetch("hail_not_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("not-covered",json, progress_step/4));
                fetch("hail_deductible.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("deductible",json, progress_step/4));
                fetch("hail_amendment.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("amendment",json, progress_step/4));
              }

              if (wind) {              
                fetch("wind_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("covered",json, progress_step/4));
                fetch("wind_not_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("not-covered",json, progress_step/4));
                fetch("wind_deductible.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("deductible",json, progress_step/4));
                fetch("wind_amendment.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("amendment",json, progress_step/4));
              }

              if (fire) {              
                fetch("fire_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("covered",json, progress_step/4));
                fetch("fire_not_covered.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("not-covered",json, progress_step/4));
                fetch("fire_deductible.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("deductible",json, progress_step/4));
                fetch("fire_amendment.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("amendment",json, progress_step/4));
              }

              if (auto) {              
                fetch("auto_coverage.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("coverage",json, progress_step/7));
                fetch("auto_liability.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("liability",json, progress_step/7));
                fetch("auto_physical.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("physical",json, progress_step/7));
                fetch("auto_UM.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("um",json, progress_step/7));
                fetch("auto_PIP.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("pip",json, progress_step/7));
                fetch("auto_exclusions.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("exclusions",json, progress_step/7));
                fetch("auto_general.json")
                  .then(response => response.json())
                  .then(json => loadSmartSheet("general",json, progress_step/7));
              }
            }
          })();
        }, 1500);
    });

    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const windCheckbox = document.getElementById('wind');
    const hailCheckbox = document.getElementById('hail');
    const fireCheckbox = document.getElementById('fire');
    const windTab = document.querySelector('[data-tab="wind"]');
    const hailTab = document.querySelector('[data-tab="hail"]');
    const fireTab = document.querySelector('[data-tab="fire"]');
    const autoTab = document.querySelector('[data-tab="auto"]');
    const damageType =  document.getElementById('damage-type');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab
            tab.classList.add('active');

            // Show corresponding content
            const tabName = tab.getAttribute('data-tab');
            document.getElementById(`${tabName}-content`).classList.add('active');
        });
    });

    // Show/hide tabs based on checkbox selection
    function updateTabVisibility() {
        if (hailCheckbox.checked) {
            hailTab.style.display = 'block';
        } else {
            hailTab.style.display = 'none';
            // If this tab was active, switch to another visible tab
            if (hailTab.classList.contains('active') && fireCheckbox.checked) {
                fireTab.click();
            }
            if (hailTab.classList.contains('active') && windCheckbox.checked) {
                windTab.click();
            }
        }

        if (windCheckbox.checked) {
            windTab.style.display = 'block';
        } else {
            windTab.style.display = 'none';
            // If this tab was active, switch to another visible tab
            if (windTab.classList.contains('active') && fireCheckbox.checked) {
                fireTab.click();
            }
            if (windTab.classList.contains('active') && hailCheckbox.checked) {
                hailTab.click();
            }
        }

        if (fireCheckbox.checked) {
            fireTab.style.display = 'block';
        } else {
            fireTab.style.display = 'none';
            // If this tab was active, switch to another visible tab
            if (fireTab.classList.contains('active') && windCheckbox.checked) {
               windTab.click();
            }
            if (fireTab.classList.contains('active') && hailCheckbox.checked) {
               hailTab.click();
            }
        }

        // If no checkboxes are selected, hide all tab content
        if (!hailCheckbox.checked && !windCheckbox.checked && !fireCheckbox.checked) {
            tabContents.forEach(content => content.classList.remove('active'));
        } else {
            // If at least one is checked and no tab is active, activate the first visible one
            const hasActiveTab = Array.from(tabs).some(tab => 
                tab.classList.contains('active') && tab.style.display !== 'none'
            );
            if (!hasActiveTab) {
                if (hailCheckbox.checked) {
                    hailTab.click();
                } else if (windCheckbox.checked) {
                    windTab.click();
                } else if (fireCheckbox.checked) {
                    fireTab.click();
                }
            }
        }
    }

    // Initialize tab visibility (hide all tabs initially)
    hailTab.style.display = 'none';
    windTab.style.display = 'none';
    fireTab.style.display = 'none';
    autoTab.style.display = 'none';

    // Listen for checkbox changes
    hailCheckbox.addEventListener('change', updateTabVisibility);
    windCheckbox.addEventListener('change', updateTabVisibility);
    fireCheckbox.addEventListener('change', updateTabVisibility);

    function loadPolicyDetails(json) {
      const form = new FormData();
      form.append('questions', JSON.stringify(json));
      (async () => {
        var rawResponse = await fetch('/api/pdf-qa', {
          method: 'POST',
          headers: {
            'accept': 'application/json'
          },
          body: form
        });
        
        var answers = await rawResponse.json();

        var policyDetails = document.getElementById("policy-details");
        policyDetails.innerHTML = `
                <table><tr><td><strong>Policy Holder:</strong><br>${answers[0].answer}</td></tr>
                <tr><td><strong>Policy Address:</strong><br>${answers[1].answer}</td></tr>
                <tr><td><strong>Policy Number:</strong><br>${answers[2].answer}</td></tr>
                <tr><td><strong>Policy Period:</strong><br>${answers[3].answer}</td></tr></table>
        `;
      
      })();
    }

    function loadSmartSheet(section, json, progress_step) {
      const form = new FormData();
        form.append('questions', JSON.stringify(json));

      (async () => {
        const rawResponse = await fetch('/api/pdf-qa', {
          method: 'POST',
          headers: {
            'accept': 'application/json'
          },
          body: form
        });
        
        const answers = await rawResponse.json();
        var arrayLength = answers.length;
        
        tableId=json.damage_type.toLowerCase() + "-" + section + "-table";
            
        var currentTable = document.getElementById(tableId);
        var new_tbody = document.createElement('tbody');
        new_tbody.id = tableId;
        new_tbody.classList.add("content-body");
        
        for (var i = 0; i < arrayLength; i++) {
            var row = document.createElement("tr");
            
            var columnQ = document.createElement("td");
            columnQ.classList.add("question-cell");
            columnQ.textContent = answers[i].question;
            row.appendChild(columnQ);
            
            var columnA = document.createElement("td");
            columnA.classList.add("answer-cell");
            if (isJson(answers[i].answer)) {
              var currentAnswer = JSON.parse(answers[i].answer);
              var divA = document.createElement("div");
              if (Array.isArray(currentAnswer)) {
                jsonArrayToHTMLList(currentAnswer, divA);
              } else {
                jsonObjectToHtml(currentAnswer, divA);
              }
                columnA.appendChild(divA);
            } else {
              columnA.textContent = answers[i].answer;
            }
            row.appendChild(columnA);
           
            new_tbody.appendChild(row);
         }
         
         currentTable.parentNode.replaceChild(new_tbody, currentTable)
         
         setProgress(getProgress()+progress_step);

         tabId=json.damage_type.toLowerCase() + "-tab";
         document.getElementById(tabId).click();
         
      })();
    }
    
    function isJson(str) {
      try {
          JSON.parse(str);
      } catch (e) {
          return false;
      }
      return true;
    }
    
    function jsonObjectToHtml(jsonObj, targetDiv) {
      var jsonParentDiv = document.createElement("div");
      jsonParentDiv.classList.add("json-container");
      
      for (const [key, value] of Object.entries(jsonObj)) {
        var jsonItemDiv = document.createElement("div");
        jsonItemDiv.classList.add("json-item");
        jsonItemDiv.innerHTML = `
            <strong class="json-key">${escapeHtml(key)}:</strong>
            <span class="json-value">${escapeHtml(value)}</span>
        `;
        jsonParentDiv.appendChild(jsonItemDiv);
      }
      
      targetDiv.appendChild(jsonParentDiv);
    }
    
    function jsonArrayToHTMLList(jsonArray, targetDiv) {
      var answerList = document.createElement("ul");
      for (var i = 0; i < jsonArray.length; i++) {
        var answerItem = document.createElement("li");
        answerItem.innerHTML = escapeHtml(jsonArray[i]);
        answerList.appendChild(answerItem);
      }
      targetDiv.appendChild(answerList);
    }

    // Helper function to escape HTML special characters
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }
    
    function setProgress(percentage) {
      // Ensure percentage is between 0 and 100
      percentage = Math.max(0, Math.min(100, percentage));
      
      
      progressBar.style.width = percentage + '%';
      progressBar.textContent = Math.round( percentage ) + '%';
    }

    function getProgress() {
      return parseFloat(progressBar.style.width);
    }

    const progressBar = document.getElementById('progressBar');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const exportButton = document.getElementById('exportButton');
    const nextStepsButton = document.getElementById('nextStepsButton');

    function addMessage(text, isUser) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = isUser ? 'U' : 'L';
      
      const content = document.createElement('div');
      content.className = 'message-content';
      content.textContent = text;
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);
      messagesContainer.appendChild(messageDiv);
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      sendButton.disabled = false;             
    }

    function sendMessage() {
      var text = messageInput.value.trim();
      if (!text) return;
      
      addMessage(text, true);
      
      sendButton.disabled = true;             
      var chatQuestions = { questions: [] };
      chatQuestions.questions.push(text);

      var chatForm = new FormData();
      chatForm.append('questions', JSON.stringify(chatQuestions));

      messageInput.value = '';
      
      fetch('/api/pdf-qa', {
        method: 'POST',
        headers: { 'accept': 'application/json' },
        body: chatForm
      })
      .then(response => response.json())
      .then(chatAnswers => addMessage(chatAnswers[0].answer, false));
      
    }

    sendButton.addEventListener('click', sendMessage);
    exportButton.addEventListener('click', exportSmartSheets);
    nextStepsButton.addEventListener('click', showNextSteps);

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
          sendMessage();
      }
    });

    messageInput.focus();

    function isAuto() {
      var url = window.location.href;
      var lastPart = url.substr(url.lastIndexOf('/') + 1);
      if (lastPart == "") {
         lastPart = url.substr(url.lastIndexOf('/', url.lastIndexOf('/')-1)+1, 4);
      } 
      if (lastPart === "auto")
        return true;
        
      return false;
    }

    window.onload = function() { 

      if (isAuto()) {
        autoTab.style.display = 'block';
        damageType.style.display = 'none';
        nextStepsButton.style.display = 'none';
      }  else {
        autoTab.style.display = 'none';
        damageType.style.display = 'block';            
      }
      
    }
    
    function showNextSteps() {
      var nextStepsFile = ""
      if (hailTab.classList.contains('active'))
        nextStepsFile = "hail_next_steps.json";
        
      if (windTab.classList.contains('active'))
        nextStepsFile = "wind_next_steps.json";
     
      if (fireTab.classList.contains('active'))
        nextStepsFile = "fire_next_steps.json";
      
      if (isAuto())
        nextStepsFile = "";
        
      if (nextStepsFile != "") {
          fetch(nextStepsFile)
            .then(response => response.json())
            .then(json => displayNextSteps(json));
      
      }
    }    
    
    function displayNextSteps(nextStepsJson) {
        const damage_type = nextStepsJson.damage_type;
        var nextStepsLength = nextStepsJson.next_steps.length;
        
        var popupContent = document.getElementById("popupContent");
        popupContent.innerHTML = `<h3>${damage_type} Next Steps:</h3>`;
        
        var nextStepsTable = document.createElement('tbody');
        for (var i = 0; i < nextStepsLength; i++) {
            var row = document.createElement("tr");
            var section = document.createElement("th");
            section.setAttribute("style", "float: left;");
            section.textContent = nextStepsJson.next_steps[i].section;
            row.appendChild(section);
            nextStepsTable.appendChild(row);
            
            var stepsLength = nextStepsJson.next_steps[i].steps.length;
            for (var n = 0; n < stepsLength; n++) {
              row = document.createElement("tr");
              row.classList.add("spaceUnder");
              var step = document.createElement("td");
              step.textContent = nextStepsJson.next_steps[i].steps[n];
              row.appendChild(step);
              nextStepsTable.appendChild(row);
            }
         }
         
         popupContent.appendChild(nextStepsTable);
         openPopup();
    }
    
    function exportSmartSheets() {
        if (hailTab.classList.contains('active'))
          exportSmartSheet("hail-content");
          
        if (windTab.classList.contains('active'))
          exportSmartSheet("wind-content");
       
        if (fireTab.classList.contains('active'))
          exportSmartSheet("fire-content");
          
        if (isAuto())
          exportSmartSheet("auto-content");
    }
    
    function exportSmartSheet(smartSheetName) {
      var pdf = new jsPDF('p', 'pt', 'letter');
      // source can be HTML-formatted string, or a reference
      // to an actual DOM element from which the text will be scraped.
      source = document.getElementById(smartSheetName);

      // we support special element handlers. Register them with jQuery-style 
      // ID selector for either ID or node name. ("#iAmID", "div", "span" etc.)
      // There is no support for any other type of selectors 
      // (class, of compound) at this time.
      specialElementHandlers = {
          // element with id of "bypass" - jQuery style selector
          '#bypassme': function (element, renderer) {
              // true = "handled elsewhere, bypass text extraction"
              return true
          }
      };
      margins = {
          top: 80,
          bottom: 60,
          left: 40,
          width: 522
      };
      // all coords and widths are in jsPDF instance's declared units
      // 'inches' in this case
      pdf.fromHTML(
          source, // HTML string or DOM elem ref.
          margins.left, // x coord
          margins.top, { // y coord
              'width': margins.width, // max width of content on PDF
              'elementHandlers': specialElementHandlers
          },

          function (dispose) {
              // dispose: object with X, Y of the last line add to the PDF 
              //          this allow the insertion of new lines after html
              pdf.save(smartSheetName+'.pdf');
          }, margins
      );
    }

    function openPopup() {
      document.getElementById('popupOverlay').classList.add('active');
    }

    function closePopup() {
      document.getElementById('popupOverlay').classList.remove('active');
    }

    // Close popup when pressing Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') 
          closePopup();
    });
    
    document.querySelectorAll('.section-header').forEach(header => {
      header.addEventListener('click', () => {
        const target = document.getElementById(header.dataset.target);
        target.classList.toggle('hidden');
      });
    });
  </script>
</html>
